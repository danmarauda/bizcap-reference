stages:
  - validate
  - test
  - build
  - security
  - deploy-dev
  - integration-test
  - deploy-staging
  - e2e-test
  - deploy-prod

variables:
  NODE_VERSION: "20"
  PNPM_VERSION: "8"
  CACHE_KEY: "$CI_COMMIT_REF_SLUG"

# Cache configuration
cache:
  key: $CACHE_KEY
  paths:
    - .pnpm-store/
    - node_modules/
    - packages/*/node_modules/
    - .next/cache/

# Base image
image: node:20-slim

before_script:
  - corepack enable
  - corepack prepare pnpm@latest --activate
  - pnpm config set store-dir .pnpm-store

# Validation Stage
validate:code:
  stage: validate
  script:
    - pnpm install --frozen-lockfile
    - pnpm lint
    - pnpm typecheck
    - pnpm format:check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

validate:dependencies:
  stage: validate
  script:
    - pnpm audit --audit-level moderate
    - pnpm outdated
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Testing Stage
test:unit:
  stage: test
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  script:
    - pnpm install --frozen-lockfile
    - pnpm test:unit --coverage --ci
    - pnpm test:coverage:report
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:integration:
  stage: test
  script:
    - pnpm install --frozen-lockfile
    - pnpm test:integration
  services:
    - name: postgres:15
      alias: postgres
    - name: redis:7
      alias: redis
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_pass
    DATABASE_URL: postgresql://test_user:test_pass@postgres:5432/test_db
    REDIS_URL: redis://redis:6379
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

test:visual:
  stage: test
  script:
    - pnpm install --frozen-lockfile
    - pnpm test:visual
  artifacts:
    paths:
      - visual-tests/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Build Stage
build:web:
  stage: build
  script:
    - pnpm install --frozen-lockfile
    - pnpm build:web
    - pnpm build:analyze
  artifacts:
    paths:
      - packages/web/.next/
      - packages/web/out/
      - build-analysis/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:native:
  stage: build
  script:
    - pnpm install --frozen-lockfile
    - pnpm build:native
  artifacts:
    paths:
      - packages/native/dist/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

build:shared:
  stage: build
  script:
    - pnpm install --frozen-lockfile
    - pnpm build:shared
  artifacts:
    paths:
      - packages/shared/*/dist/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Security Stage
security:scan:
  stage: security
  script:
    - pnpm audit --audit-level moderate
    - npm install -g @vercel/ncc
    - pnpm security:scan
  artifacts:
    paths:
      - security-reports/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Deploy to Development
deploy:dev:web:
  stage: deploy-dev
  environment:
    name: development/web
    url: https://bizcap-dev.vercel.app
    on_stop: stop:dev:web
  script:
    - pnpm vercel:deploy --prebuilt --token $VERCEL_TOKEN
  dependencies:
    - build:web
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

deploy:dev:native:
  stage: deploy-dev
  environment:
    name: development/native
  script:
    - pnpm eas:build --profile development --non-interactive
    - pnpm eas:submit --platform all --non-interactive
  dependencies:
    - build:native
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

deploy:dev:backend:
  stage: deploy-dev
  environment:
    name: development/backend
    url: https://bizcap-dev.up.railway.app
  script:
    - pnpm railway:login
    - pnpm railway:up -e dev
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

# Integration Tests
test:integration:dev:
  stage: integration-test
  script:
    - pnpm test:e2e:dev
  environment:
    name: development
  dependencies:
    - deploy:dev:web
    - deploy:dev:native
    - deploy:dev:backend
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

# Deploy to Staging
deploy:staging:web:
  stage: deploy-staging
  environment:
    name: staging/web
    url: https://bizcap-staging.vercel.app
    on_stop: stop:staging:web
  script:
    - pnpm vercel:deploy --prebuilt --token $VERCEL_TOKEN
  dependencies:
    - test:integration:dev
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy:staging:native:
  stage: deploy-staging
  environment:
    name: staging/native
  script:
    - pnpm eas:build --profile preview --non-interactive
    - pnpm eas:submit --platform all --non-interactive
  dependencies:
    - test:integration:dev
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

deploy:staging:backend:
  stage: deploy-staging
  environment:
    name: staging/backend
    url: https://bizcap-staging.up.railway.app
  script:
    - pnpm railway:login
    - pnpm railway:up -e staging
  dependencies:
    - test:integration:dev
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# E2E Tests
test:e2e:staging:
  stage: e2e-test
  script:
    - pnpm test:e2e:staging
  environment:
    name: staging
  dependencies:
    - deploy:staging:web
    - deploy:staging:native
    - deploy:staging:backend
  artifacts:
    paths:
      - e2e-results/
      - e2e-screenshots/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Deploy to Production
deploy:prod:web:
  stage: deploy-prod
  environment:
    name: production/web
    url: https://bizcap.vercel.app
  script:
    - pnpm vercel:deploy --prod --prebuilt --token $VERCEL_TOKEN
  dependencies:
    - test:e2e:staging
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual

deploy:prod:native:
  stage: deploy-prod
  environment:
    name: production/native
  script:
    - pnpm eas:build --profile production --non-interactive
    - pnpm eas:submit --platform all --non-interactive
  dependencies:
    - test:e2e:staging
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual

deploy:prod:backend:
  stage: deploy-prod
  environment:
    name: production/backend
    url: https://bizcap.up.railway.app
  script:
    - pnpm railway:login
    - pnpm railway:up -e production
  dependencies:
    - test:e2e:staging
  rules:
    - if: $CI_COMMIT_TAG
    - when: manual

# Stop Development Environments
stop:dev:web:
  stage: deploy-dev
  environment:
    name: development/web
    action: stop
  script:
    - pnpm vercel:remove $VERCEL_DEPLOYMENT_URL --token $VERCEL_TOKEN
  when: manual

stop:staging:web:
  stage: deploy-staging
  environment:
    name: staging/web
    action: stop
  script:
    - pnpm vercel:remove $VERCEL_DEPLOYMENT_URL --token $VERCEL_TOKEN
  when: manual